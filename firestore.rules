rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ──────────────────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getRole() == 'admin';
    }

    function isResident() {
      return isAuthenticated() && getRole() == 'resident';
    }

    function isSecurity() {
      return isAuthenticated() && getRole() == 'security';
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // ── users ─────────────────────────────────────────────────────────────────
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ── complaints ────────────────────────────────────────────────────────────
    match /complaints/{complaintId} {
      allow read: if isAuthenticated();
      allow create: if isResident();
      allow update: if isAdmin() || isOwner(resource.data.residentId);
      allow delete: if isAdmin();
    }

    // ── visitors ──────────────────────────────────────────────────────────────
    match /visitors/{visitorId} {
      allow read: if isAuthenticated();
      allow create: if isResident() || isSecurity();
      allow update: if isSecurity() || isAdmin() || isOwner(resource.data.residentId);
      allow delete: if isAdmin();
    }

    // ── payments ──────────────────────────────────────────────────────────────
    match /payments/{paymentId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── emergencies ───────────────────────────────────────────────────────────
    match /emergencies/{emergencyId} {
      allow read: if isAuthenticated();
      allow create: if isResident() || isSecurity();
      allow update: if isAdmin() || isSecurity() || isOwner(resource.data.raisedBy);
      allow delete: if isAdmin();
    }

    // ── announcements ─────────────────────────────────────────────────────────
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── chats (community channels) ────────────────────────────────────────────
    match /chats/{chatId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAuthenticated(); // last message update
      allow delete: if isAdmin();

      // messages sub-collection
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
          && request.resource.data.userId == request.auth.uid
          && request.resource.data.text is string
          && request.resource.data.text.size() > 0
          && request.resource.data.text.size() <= 1000;
        allow update: if isAdmin();
        allow delete: if isAdmin() || isOwner(resource.data.userId);
      }
    }

    // ── funds (legacy, kept for admin use) ────────────────────────────────────
    match /funds/{fundId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

  }
}
